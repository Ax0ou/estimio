<div class="section border rounded p-3 mb-4" id="section-<%= section.id %>">
  <h4><%= section.description %></h4>

  <div class="line-items" data-section-id="<%= section.id %>" data-controller="line-items">

  <%= link_to "Remove Section", section_path(section), data: { turbo_method: :delete, turbo_confirm: "√ätes-vous s√ªr de vouloir supprimer cette section et toutes ses lignes ?" }, class: "btn btn-sm btn-outline-danger mb-2" %>

    <div class="sticky-header bg-light py-2 mb-2 rounded" style="position: sticky; top: 0; z-index: 100;">
      <div class="row text-center align-items-center">
        <div class="col-auto" style="width: 40px;"></div>
        <div class="col-md-4">Description</div>
        <div class="col-md-1">Quantit√©</div>
        <div class="col-md-1">Unit√©</div>
        <div class="col-md-2">Prix unitaire</div>
        <div class="col-md-2">Prix total</div>
      </div>
    </div>

    <div data-controller="line-items-sort"
         data-line-items-sort-url-value="<%= reorder_line_items_path %>">

      <div data-line-items-sort-target="list" id="<%= section.id %>-line-items">
        <% section.line_items.order(:position).each do |line_item| %>
          <div data-id="<%= line_item.id %>" class="draggable-line-item">
            <%= render "quotes/line_item", line_item: line_item %>
          </div>
        <% end %>
      </div>
    </div>

    <%= render "quotes/line_item", line_item: section.line_items.new %>

    <div class="card shadow-sm mt-4 ai-section-card">
      <div class="card-body">
        <h5 class="card-title mb-3">Ajouter des √©l√©ments par IA</h5>
        <div data-controller="audio-recorder">
          <%= simple_form_for :transcript, url: add_line_items_with_llm_section_path(section), html: { data: { controller: "form-validation", action: "submit->form-validation#validate" } } do |f| %>
            <%= f.input :text,
                          label: "D√©crivez les √©l√©ments √† ajouter (vous pouvez aussi utiliser le micro) :",
                          required: false, # Changed from true
                          input_html: { data: { "audio-recorder-target": "textArea", "form-validation-target": "input" }, rows: 3, class: "form-control-sm" }, # Added form-validation-target
                          placeholder: "Ex: Deux heures de pon√ßage et la mise en peinture de cinq m√®tres carr√©s de mur en blanc...", # Updated placeholder
                          label_html: { class: "form-label" } %>
            <div class="invalid-feedback" data-form-validation-target="error"></div>
            
            <!-- Zone de transcription en temps r√©el -->
            <div data-audio-recorder-target="liveTranscription" class="mt-2 p-3 bg-light border rounded" style="display: none;">
              <div class="d-flex align-items-center mb-2">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                  <span class="visually-hidden">Transcription en cours...</span>
                </div>
                <small class="text-primary fw-bold">Transcription en temps r√©el</small>
              </div>
              <div data-audio-recorder-target="liveText" class="border-start border-primary border-3 ps-3 fs-6">
                <!-- Le texte transcrit appara√Ætra ici -->
              </div>
            </div>

            <div class="d-flex gap-2 align-items-center mt-2">
              <%= f.submit 'Analyser la description', class: "btn btn-primary btn-sm" %>

              <button type="button"
                      data-action="click->audio-recorder#toggle"
                      data-audio-recorder-target="recordButton"
                      class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-mic-fill"></i>
              </button>

              <button type="button"
                      data-action="click->audio-recorder#stopRecording"
                      data-audio-recorder-target="stopButton"
                      class="btn btn-danger btn-sm" style="display: none;">
                <i class="bi bi-stop-fill"></i> Stop
              </button>

              <span data-audio-recorder-target="status" class="text-danger small" style="display: none;">
                üî¥ Enregistrement...
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
